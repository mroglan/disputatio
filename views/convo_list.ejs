<div class="d-flex" id="wrapper">
	<%- include('./partials/side_nav.ejs') %>
	<div id="page-content-wrapper">
		<%- include('./partials/top_nav.ejs') %>
		<div class="container d-xl-flex flex-xl-column" style="height:100vh">
			<div class="row" style="flex:0 1 auto">
				<div class="col-12 bg-primary pt-5">
					<h1 class="display-3 text-center text-light">Conversations</h1>
				</div>
			</div>
			<div class="row align-items-stretch no-gutters mx-n3" style="flex:1 1 auto;background:rgba(191,172,172,.5)" id="scroll-xl-less">
				<div class="col-xl-3 col-sm-7 mx-auto position-relative" style="min-height:300px">
					<div class="h-100 w-100 position-absolute overflow-auto">
						<div class="d-flex justify-content-around">
							<div><button type="button" class="btn" id="create-convo-btn"><span class="text-success" style="vertical-align:top"><i class="fas fa-plus-square"></i> New</span></button></div>
							<div><button type="button" class="btn" id="delete-convo-btn"><span class="text-danger" style="vertical-align:top"><i class="fas fa-minus-square"></i> Delete</span></button></div>
						</div>
						<div class="list-group mt-3">
							<% convos.sort((a, b) => { let dateA = a.recent_msg; let dateB = b.recent_msg; return (dateA < dateB) ? 1 : (dateA > dateB) ? -1 : 0;}); %>
							<% convos.forEach(function(convo) { %>
								<a href="/chats/conversations/<%= convo._id %>" class="list-group-item list-group-item-action pb-0 border-primary <%= typeof selected != 'undefined' && selected._id.toString() == convo._id.toString() ? 'active' : '' %>">
									<h4 class="mb-0"><%= convo.name %></h4>
									<p class="mb-0 convo_users_label">
										<% convo.users.forEach(function(cUser, index) {
											if(index != 0) { %>
												<% if(index == convo.users.length - 1) { %>
													<%= cUser.name %>
												<% } else { %>
													<%= cUser.name %>, 
												<% } %>
										<% } }); %>
									</p>
								</a>
							<% }); if(convos.length == 0) { %>
								<p class="text-center">You do not have any conversations currently</p>
							<% } %>
						</div>
					</div>
				</div>
				<div class="col-xl-6 col-sm-11 mx-auto position-relative" style="min-height:500px">
					<div class="h-100 w-100 position-absolute">
						<div class="card card-body w-100 <%= typeof errors != 'undefined' ? '' : 'd-none' %>" id="create_form">
							<h1 class="card-title text-center">New Conversation</h1>
							<% if(typeof errors != 'undefined') { %>
								<% errors.forEach(function(error) { %>
									<div class="alert alert-warning alert-dismissible fade show" role="alert">
										<%= error.msg %>
										<button type="button" class="close" data-dismiss="alert" aria-label="Close">
											<span aria-hidden="true">&times;</span>
										</button>
									</div>
								<% }); %>
							<% } %>
							<form method="POST" action="/chats/conversations/new">
								<div class="form-group row">
									<label for="name" class="col-sm-2 col-form-label">Name</label>
									<div class="col-sm-10">
										<input type="text" id="name" name="name" class="form-control" required>
									</div>
								</div>
								<div class="form-group">
									<label for="convo_users">Select Users for the Conversation</label>
									<ul class="list-group list-group-horizontal flex-wrap" id="convo_users">
									<% user.friends.forEach(function(friend) { %>
										<li class="list-group-item py-2">
											<div class="form-check">
												<input type="checkbox" class="form-check-input" name="convo_user" id="<%= friend._id %>" value="<%= friend._id %>">
												<label for="<%= friend._id %>" class="form-check-label"><%= friend.name %></label>
											</div>
										</li>
									<% }); %>
									</ul>
								</div>
								<button type="submit" class="btn btn-success">Create new Conversation</button>
							</form>
						</div>
						<% if(typeof selected != 'undefined') { %>
							<div class="message-box">
								<div class="chat-title">
									<h1 class="text-center"><%= selected.name %></h1>
								</div>
								<div class="content overflow-auto">
									<% selected.messages.forEach(function(message) { %>
										<% if(message.writer.toString() == user._id.toString()) { %>
											<div class="green message float-right mb-3">
												<div><%= message.message %></div>
											</div>
										<% } else { %>
											<div class="gray message float-left mb-3">
												<div><%= message.message %></div>
											</div>
										<% } %>
									<% }); %>
								</div>
								<div class="writing">
									<form method="POST" action="">
										<textarea id="message" name="message" required placeholder="Type your message here"></textarea>
										<button type="submit" class="btn btn-primary">Submit</button>
									</form>
								</div>
							</div>
						<% } %>
					</div>
				</div>
				<div class="col-xl-3 col-sm-7 mx-auto position-relative" style="min-height:300px">
					<div class="h-100 w-100 position-absolute rounded-lg">
						<% if(typeof selected != 'undefined') { %>
							<div class="card w-100 h-100" id="convo_info_card">
								<div class="card-header">
									<p class="card-title text-center">Created on <%= selected.date_format %> by <a href="/users/<%= selected.start_user._id %>/profile"><%= selected.start_user.name %></a></p>
								</div>
								<div class="card-body overflow-auto px-xl-1">
									<div class="d-flex flex-row flex-wrap justify-content-center">
										<% selected.users.forEach(function(sUser) { %>
											<div class="p-2 pic-flex-item">
												<div class="w-100 h-100 overflow-hidden rounded-circle border-primary">
													<a href="/users/<%= sUser._id %>/profile">
														<img title="&lt;<%= sUser.tag %>&gt;" class="img-fluid" style="min-width:100%;min-height:100%" src="<%= sUser.picture || '/images/blank_profile.png' %>">
													</a>
												</div>
											</div>
										<% }); %>
									</div>
								</div>
								<div class="card-footer">
									<div class="d-flex justify-content-around">
										<button type="button" class="btn btn-success mx-3" id="add_members">Add Members</button>
										<% if(user._id.toString() == selected.start_user._id.toString()) { %>
											<button type="button" class="btn btn-danger mx-3" id="remove_members">Remove Members</button>
										<% } %>
									</div>
								</div>
							</div>
						<% } %>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>
